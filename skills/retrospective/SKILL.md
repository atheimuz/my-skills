---
name: retrospective
description: >
    개발 세션 후 회고를 수행하여 CLAUDE.md와 에이전트 프롬프트를 개선.
    현재 세션에서 발생한 문제점, 반복 수정, 패턴 불일치를 분석하고
    프로젝트 설정을 업그레이드.
    /retrospective, "회고", "세션 정리", "CLAUDE.md 업데이트",
    "프로젝트 규칙 개선", "학습 반영" 등으로 트리거.
---

# Retrospective

개발 세션 회고를 수행하여 CLAUDE.md와 에이전트 프롬프트를 개선.

## 워크플로우

### 1단계: 세션 컨텍스트 분석

대화 컨텍스트에서 다음 패턴을 추출한다:

- 반복 수정된 코드 (같은 파일 3회+ 수정)
- 사용자가 직접 교정한 부분 ("이건 이렇게 해야 해" 류)
- 테스트 실패 후 패턴을 바꿔서 통과시킨 사례
- 에이전트 산출물이 Phase 4에서 변경된 사례

5가지 카테고리로 분류:

| 카테고리            | 설명                                |
| ------------------- | ----------------------------------- |
| `pattern-mismatch`  | 프로젝트 패턴과 다르게 구현 후 수정 |
| `missing-rule`      | CLAUDE.md에 없어서 매번 수동 교정   |
| `test-convention`   | 테스트 작성 규칙 불일치             |
| `agent-gap`         | 에이전트가 놓친 컨텍스트            |
| `workflow-friction` | 워크플로우 자체의 비효율            |

### 2단계: 현재 프로젝트 설정 수집

1. `Glob("**/CLAUDE.md")`로 기존 CLAUDE.md 수집 및 Read
2. `Glob("agents/*.md")`로 에이전트 프롬프트 Read (해당 세션에서 사용된 에이전트 중심)

### 3단계: 학습 항목 도출

각 문제점을 학습 항목(Learning Item)으로 구조화:

```markdown
### L-001: {제목}

- **카테고리**: pattern-mismatch
- **발견 경위**: {세션에서의 상황}
- **현재 상태**: CLAUDE.md에 규칙 없음
- **제안 변경**:
    - **대상 파일**: {CLAUDE.md 또는 agents/\*.md}
    - **변경 내용**: {추가/수정 내용}
- **근거**: {구체 사례}
```

학습 항목이 0건이면 "이번 세션에서 특별한 학습 항목이 발견되지 않았습니다" 메시지 출력 후 종료.

### 4단계: 변경 제안서 (사용자 확인)

학습 항목을 정리하여 사용자에게 AskUserQuestion으로 표시:

```
회고 분석 결과:

[CLAUDE.md 변경 제안 (N건)]
- L-001: {제목} → {대상 파일}: {변경 요약}
- L-002: {제목} → {대상 파일}: {변경 요약}

[에이전트 프롬프트 변경 제안 (M건)]
- L-003: {제목} → {대상 파일}: {변경 요약}

[참고용 — 별도 검토 필요]
- L-004: {workflow-friction} {설명}
```

선택지:

- "전체 적용" — 모든 변경 제안 적용
- "선택 적용" — 적용할 항목 번호 입력 요청
- "수정 후 적용" — 사용자가 제안 내용을 수정한 뒤 적용
- "건너뛰기" — 변경 없이 종료

### 5단계: 변경 적용

사용자 승인 항목만 적용:

**CLAUDE.md 처리:**

- CLAUDE.md가 없으면 새로 생성 (기본 섹션: 코딩 규칙, 금지 사항, 테스트 규칙)
- 있으면 Grep으로 중복 검사 후 적절한 섹션에 추가
- 기존 규칙과 충돌하는 경우 사용자에게 확인

**에이전트 프롬프트 처리:**

- 해당 .md 파일의 적절한 섹션에 규칙 추가
- 기존 내용과 중복되지 않도록 확인

### 6단계: 결과 확인

변경 파일 목록을 표시하고 AskUserQuestion으로 후속 조치 선택:

- "확인(diff)" — 변경 사항 diff 표시
- "커밋" — 변경 사항 커밋
- "완료" — 종료

## 핵심 제약

- **서브에이전트 미사용** — 대화 컨텍스트 분석이 핵심이므로 메인 에이전트가 직접 수행
- **모든 변경은 사용자 승인 후** 적용
- 학습 항목은 구체적 근거(세션 내 사례)가 있는 것만 포함
- workflow-friction 항목은 직접 적용하지 않고 참고용으로만 보고
