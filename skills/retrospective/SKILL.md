---
name: retrospective
description: >
    개발 세션 후 회고를 수행하여 CLAUDE.md, 에이전트 프롬프트, 스킬 프롬프트를 개선.
    현재 세션에서 발생한 문제점, 반복 수정, 패턴 불일치를 분석하고
    프로젝트 설정을 업그레이드.
    /retrospective, "회고", "세션 정리", "CLAUDE.md 업데이트",
    "프로젝트 규칙 개선", "학습 반영" 등으로 트리거.
---

# Retrospective

개발 세션 회고를 수행하여 CLAUDE.md, 에이전트 프롬프트, 스킬 프롬프트를 개선.

## 워크플로우

### 1단계: 세션 컨텍스트 분석

대화 컨텍스트에서 다음 패턴을 추출한다:

- 반복 수정된 코드 (같은 파일 3회+ 수정)
- 사용자가 직접 교정한 부분 ("이건 이렇게 해야 해" 류)
- 테스트 실패 후 패턴을 바꿔서 통과시킨 사례
- 에이전트 산출물이 Phase 4에서 변경된 사례
- 동일하거나 유사한 명령어/작업을 2회 이상 반복 수행한 패턴
- 매번 수동으로 수행하는 정형화된 절차 (검증, 파일 생성, 포맷팅 등)

7가지 카테고리로 분류:

| 카테고리               | 설명                                |
| ---------------------- | ----------------------------------- |
| `pattern-mismatch`  | 프로젝트 패턴과 다르게 구현 후 수정 |
| `missing-rule`      | CLAUDE.md에 없어서 매번 수동 교정   |
| `test-convention`   | 테스트 작성 규칙 불일치             |
| `agent-gap`         | 에이전트가 놓친 컨텍스트            |
| `skill-gap`         | 스킬 프롬프트의 부족, 오류, 범위 누락 |
| `workflow-friction`    | 워크플로우 자체의 비효율            |
| `automation-candidate` | 반복 수행되어 자동화할 수 있는 작업 |

### 2단계: 현재 프로젝트 설정 수집

1. `Glob("**/CLAUDE.md")`로 기존 CLAUDE.md 수집 및 Read
2. `Glob("agents/**/*.md")`로 에이전트 프롬프트 Read (해당 세션에서 사용된 에이전트 중심)
3. `Glob("skills/**/SKILL.md")`로 스킬 프롬프트 Read (해당 세션에서 사용된 스킬 중심)

### 3단계: 학습 항목 도출

각 문제점을 학습 항목(Learning Item)으로 구조화:

```markdown
### L-001: {제목}

- **카테고리**: pattern-mismatch
- **발견 경위**: {세션에서의 상황}
- **현재 상태**: CLAUDE.md에 규칙 없음
- **제안 변경**:
    - **대상 파일**: {CLAUDE.md 또는 agents/\*\*/\*.md 또는 skills/\*/SKILL.md}
    - **변경 내용**: {추가/수정 내용}
- **근거**: {구체 사례}
```

#### 자동화 추천 항목

`automation-candidate` 카테고리 항목은 별도 구조로 작성:

```markdown
### A-001: {제목}

- **반복 패턴**: {세션에서 반복된 구체 행동}
- **빈도**: {세션 내 발생 횟수}
- **추천 자동화 방식**:
    - **유형**: {새 스킬 생성 | hook 설정 | 스크립트/alias | 기존 스킬 확장}
    - **구현 방안**: {구체적인 자동화 방법}
- **기대 효과**: {시간 절감, 실수 방지 등}
```

학습 항목과 자동화 추천이 모두 0건이면 "이번 세션에서 특별한 학습 항목이 발견되지 않았습니다" 메시지 출력 후 종료.

### 4단계: 변경 제안서 (사용자 확인)

학습 항목을 정리하여 사용자에게 AskUserQuestion으로 표시:

```
회고 분석 결과:

[CLAUDE.md 변경 제안 (N건)]
- L-001: {제목} → {대상 파일}: {변경 요약}
- L-002: {제목} → {대상 파일}: {변경 요약}

[에이전트 프롬프트 변경 제안 (M건)]
- L-003: {제목} → {대상 파일}: {변경 요약}

[스킬 프롬프트 변경 제안 (P건)]
- L-004: {제목} → {대상 파일}: {변경 요약}

[자동화 추천 (Q건)]
- A-001: {제목} → {유형}: {구현 방안 요약}
- A-002: {제목} → {유형}: {구현 방안 요약}

[참고용 — 별도 검토 필요]
- L-005: {workflow-friction} {설명} (스킬/에이전트와 무관한 워크플로우 이슈)
```

선택지:

- "전체 적용" — 모든 변경 제안 적용
- "선택 적용" — 적용할 항목 번호 입력 요청
- "수정 후 적용" — 사용자가 제안 내용을 수정한 뒤 적용
- "건너뛰기" — 변경 없이 종료

### 5단계: 변경 적용

사용자 승인 항목만 적용:

**CLAUDE.md 처리:**

- CLAUDE.md가 없으면 새로 생성 (기본 섹션: 코딩 규칙, 금지 사항, 테스트 규칙)
- 있으면 Grep으로 중복 검사 후 적절한 섹션에 추가
- 기존 규칙과 충돌하는 경우 사용자에게 확인

**에이전트 프롬프트 처리:**

- 해당 .md 파일의 적절한 섹션에 규칙 추가
- 기존 내용과 중복되지 않도록 확인

**스킬 프롬프트 처리:**

- 해당 SKILL.md 파일의 적절한 섹션에 규칙/지침 추가
- 기존 내용과 중복되지 않도록 확인
- frontmatter description은 변경하지 않음 (워크플로우 본문만 수정)

**자동화 추천 처리:**

사용자가 승인한 자동화 추천 항목에 대해:

- **새 스킬 생성**: `skills/{스킬명}/SKILL.md` 초안 생성 (frontmatter + 기본 워크플로우)
- **Hook 설정**: `.claude/settings.json`의 hooks 섹션에 추가할 설정 제안
- **스크립트/alias**: 프로젝트 루트 또는 사용자 셸 설정에 추가할 내용 안내
- **기존 스킬 확장**: 해당 SKILL.md에 워크플로우 단계 추가

자동화 구현은 초안/골격만 생성하고, 상세 구현은 사용자가 후속 세션에서 완성

### 6단계: 결과 확인

변경 파일 목록을 표시하고 AskUserQuestion으로 후속 조치 선택:

- "확인(diff)" — 변경 사항 diff 표시
- "커밋" — 변경 사항 커밋
- "완료" — 종료

## 핵심 제약

- **서브에이전트 미사용** — 대화 컨텍스트 분석이 핵심이므로 메인 에이전트가 직접 수행
- **모든 변경은 사용자 승인 후** 적용
- 학습 항목은 구체적 근거(세션 내 사례)가 있는 것만 포함
- workflow-friction 중 스킬/에이전트 프롬프트로 해결 가능한 항목은 skill-gap 또는 agent-gap으로 재분류하여 적용 대상에 포함
- 스킬/에이전트와 무관한 workflow-friction (도구 제약, 외부 환경 등)은 참고용으로만 보고
- 자동화 추천은 세션 내 2회+ 반복이 확인된 구체적 행동에만 적용 (추측 금지)
- 자동화 구현 시 초안만 생성하며, 기존 스킬/설정을 덮어쓰지 않음
