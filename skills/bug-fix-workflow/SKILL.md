# Bug Fix Workflow Skill

버그 수정 워크플로우 스킬. 분석 → 수정 → 테스트 → 검증 파이프라인을 자동화합니다.
Feature별 버그 수정 기록을 `.claude/bug-report/`에 관리하며, 반복 수정 루프를 지원합니다.

## Triggers

- `/bug-fix`
- `버그 수정`
- `버그 분석`
- `bug fix`

## Description

버그 수정 과정을 체계화된 파이프라인으로 실행합니다:
- 심각도에 따라 단순/복합 워크플로우 자동 선택
- Feature별 폴더에 버그 리포트 및 수정 기록 관리
- 이전 버그 기록을 참조하여 중복 실패 회피
- 분석 → 수정 → 검증 루프를 해결될 때까지 반복

## Usage

```bash
# 기본 사용
/bug-fix

# 버그 설명과 함께
/bug-fix 로그인 버튼 클릭 시 에러 발생
```

## Workflow

### 단순 버그 (Minor)
- UI 오타, 스타일 문제 등
- 빠른 분석+수정 후 테스트

### 복합 버그 (Major/Critical)
1. **이전 기록 확인**: 같은 feature의 이전 버그 기록 참조
2. **분석**: 근본 원인 파악 (bug-analyzer)
3. **사용자 확인**: 분석 결과 검토
4. **수정 루프**: 수정 계획 → 수정 → 검증 → 미해결 시 재계획 반복
5. **테스트**: 회귀 테스트 작성 (regression-tester)
6. **검증**: 테스트 실행 및 확인 (verification-agent)
7. **최종 확인**: 사용자 검토

## Outputs

프로젝트 내 `.claude/bug-report/{feature}/{bug}/`에 저장:
- `report.md` - 버그 리포트 + 수정 시도 기록 통합 문서

## Instructions

<instruction>
이 스킬이 트리거되면 다음을 수행하세요:

### 1. 버그 정보 수집

$ARGUMENTS가 있으면 버그 설명으로 사용합니다. 없으면 사용자에게 질문합니다.

AskUserQuestion으로 심각도와 feature명을 확인합니다:
- **심각도**: Minor / Major / Critical
- **Feature명**: 버그가 속하는 기능 영역 (예: auth, dashboard, payment)

에러 로그나 재현 단계가 있다면 추가로 수집합니다.

### 2. 이전 버그 기록 확인

`.claude/bug-report/{feature}/` 디렉토리가 있으면:
- 기존 report.md들을 스캔하여 이전 수정 기록 확인
- 유사한 증상, 실패한 접근법, 성공한 패턴 파악
- 이 정보를 수정 계획 수립 시 활용

### 3. 산출물 디렉토리 및 report.md 생성

```bash
mkdir -p .claude/bug-report/{feature}/{bug-short-description}
```

report.md를 생성하고 버그 정보 섹션을 작성합니다:

```markdown
# {버그 제목}

## 버그 정보
- **Feature**: {feature}
- **심각도**: Minor | Major | Critical
- **최초 보고일**: {date}
- **상태**: 미해결

## 증상
{버그 설명}

## 에러 로그
{에러 로그 - 없으면 "없음"}

## 재현 단계
1. ...

---

## 수정 시도 #1 - {date}

### 분석
- **근본 원인 추정**: ...
- **영향 범위**: ...
- **이전 기록 참고**: {이전 기록에서 발견한 관련 정보, 없으면 "없음"}

### 수정 계획
- [ ] {할 일 1}
- [ ] {할 일 2}
- [ ] 검증: {검증 방법}

### 수정 결과
(수정 완료 후 작성)
```

### 4. 수정 루프 (핵심 프로세스)

**Minor 버그**:
- 분석과 수정을 통합하여 빠르게 처리
- **UI/인터랙션 버그인 경우**: 수정 전에 Playwright 검증 테스트를 먼저 작성하고, 수정 후 테스트 통과를 확인한다. 빌드 성공만으로 검증 완료로 간주하지 않는다. 테스트 파일은 임시 파일로 생성하고 검증 완료 후 삭제한다.
- **그 외 버그**: 간단한 테스트 작성 및 실행

**Major/Critical 버그**:
- `~/.claude/agents/bug-fix/bug-analyzer.md` 참조하여 분석 수행
- 분석 결과를 사용자에게 확인 (AskUserQuestion)
- `~/.claude/agents/bug-fix/bug-fixer.md` 참조하여 수정 수행
- `~/.claude/agents/bug-fix/regression-tester.md` 참조하여 테스트 작성
- `~/.claude/agents/bug-fix/verification-agent.md` 참조하여 검증 수행

**반복 루프 (심각도 무관)**:
```
반복 (최대 5회):
  1. report.md에 수정 계획 (todo 체크리스트) 작성
  2. 수정 실행
  3. report.md의 todo 항목을 [x]로 체크
  4. 검증 실행
  5. 해결됨 → report.md 상태를 "해결"로 업데이트, 수정 결과 기록, 루프 종료
     미해결 → 실패 원인 기록 → 새 "수정 시도 #N" 섹션 추가 (이전 시도 참고) → 1로 돌아감
```

수정 시도 추가 시 이전 시도의 실패 원인을 명시적으로 참고:
```markdown
## 수정 시도 #2 - {date}

### 분석
- **이전 시도 참고**: #1에서 {X} 접근이 실패. 원인은 {Y}. 이번에는 {Z} 접근으로 전환.
```

### 심각도 분류 보충 규칙

다음 특성을 가진 버그는 Minor처럼 보여도 **Major로 분류**한다:
- 첫 시도와 재시도의 동작이 다른 경우 (상태, 캐시, 초기화 순서 등 내부 조건에 따라 결과가 달라짐)
- 수정 방향이 직관적으로 명확하지 않은 경우 (어느 레이어를 고쳐야 하는지 불분명)
- 프레임워크/플랫폼 내부 상태(이벤트 라우팅, 생명주기, 활성화 상태 등)에 의존하는 동작

Major로 분류 시: formal bug-analyzer 분석 단계를 거친다. 직감 기반 빠른 수정으로 시작하지 않는다.

### 핵심 검증 규칙 (심각도 무관)

**가정 검증 우선 원칙:**
- 프레임워크/런타임 동작(마운트/언마운트 타이밍, 상태 유지 여부, 라이프사이클 순서, 앱 활성화 정책, 윈도우/프로세스 표시 조건, 초기화 순서 등)에 의존하는 구현 시, 가정을 로그 출력(console.log, print, 로그 파일 등) 또는 테스트 코드로 먼저 검증한 후 구현한다.
- "아마 이렇게 동작할 것" 기반의 구현은 금지한다.

**2회 실패 시 전환 규칙:**
- 동일 버그에 대해 같은 접근법(같은 파일/같은 패턴)으로 2회 수정해도 해결되지 않으면, 즉시 로그/테스트로 현재 동작을 진단하여 실제 동작을 확인한 후 접근법을 전환한다.
- 3회 이상 같은 접근법을 반복하지 않는다.
- report.md의 이전 수정 시도 기록이 이 규칙을 자동으로 지원한다.

**자체 검증 루프 (기본 동작):**
- 버그 수정 시 **항상** 한 턴 안에서 수정→빌드→자체검증 루프를 성공할 때까지 반복한다. 사용자의 별도 요청이 없어도 이것이 기본이다.
- 매 반복마다 반드시 자체 검증(바이너리 실행, 테스트, 로그 확인)을 수행한다. 빌드 성공만으로 사용자에게 돌아가지 않는다.
- 3회 반복 후에도 해결되지 않으면 접근법을 전환한다 (2회 실패 시 전환 규칙 적용).
- 총 5회 반복 후에도 미해결 시 현재까지의 진단 결과를 정리하여 사용자에게 보고한다.
- 사용자에게 "확인해주세요"로 검증을 떠넘기는 것은 자체 검증이 기술적으로 불가능한 경우에만 허용된다.

**자체 검증 필수 원칙:**
- 사용자에게 "확인해보세요"라고 요청하기 전에, 가능한 범위에서 자체 검증을 먼저 수행한다.
- 빌드 성공 ≠ 버그 수정 완료. 실제 동작 검증이 필요하다.
- 검증 수단은 프로젝트 유형에 맞게 선택한다:
  - **웹 앱**: dev 서버 + Playwright
  - **네이티브/데스크톱 앱**: 빌드된 바이너리 직접 실행 + 로그 파일(`/tmp/` 등)로 상태 확인. 프로세스가 정상 기동하는지, 윈도우/UI가 생성되는지 로그로 검증한다.
  - **CLI/서버**: 직접 실행 + stdout/stderr 캡처
  - **라이브러리**: 테스트 코드 실행
- **자동화 검증이 불가한 버그** (시각적 렌더링, 외부 디바이스 의존 등): 수동 재현 체크리스트를 작성하여 사용자에게 제공한다. 형식: "[사전 조건 설정] → [재현 단계] → [예상 결과] 확인"

### 5. 프로젝트 컨텍스트 활용

- CLAUDE.md가 있다면 프로젝트 규칙 준수
- package.json에서 테스트 프레임워크 및 명령어 감지
- 기존 테스트 패턴 분석 및 일관성 유지
- `.claude/bug-report/`에서 이전 버그 수정 기록 참조

### 6. 결과 보고

수정 요약, 변경된 파일, 테스트 결과, 시도 횟수를 간결하게 보고합니다.
report.md의 상태를 "해결"로 업데이트하고, 최종 수정 결과를 기록합니다.
</instruction>

## Related Files

- `~/.claude/agents/bug-fix/bug-analyzer.md`
- `~/.claude/agents/bug-fix/bug-fixer.md`
- `~/.claude/agents/bug-fix/regression-tester.md`
- `~/.claude/agents/bug-fix/verification-agent.md`
- `~/.claude/commands/bug-fix.md`
- `~/.claude/skills/bug-fix-workflow/patterns/common-bugs.md`
